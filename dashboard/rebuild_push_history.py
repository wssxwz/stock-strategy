"""用用户提供的 Telegram 推送原文重建 push_history.json

用法：把 Telegram 推送原文粘贴到 RAW_MSG 变量里运行
"""

import json, os, re
from datetime import datetime

# ── 粘贴你的 Telegram 推送原文到这里 ──────────────────────────────────
RAW_MSG = r"""
📣 全市场扫描信号（2026-02-23 23:07 北京）

✅ 本次触发：买入 12 / 卖出 0

BUY_SIGNAL:ANET:78
🎯 **ANET** — ✅ 买入信号
━━━━━━━━━━━━━━━━━━
📊 评分：78/100
💰 当前价：$137.2
⏰ 时间：2026-02-23 23:05 (北京)

📈 技术指标:
  RSI14: 29.1  |  BB%: 0.248
  MACD 柱：-0.4079  |  量比：0.79
  趋势：✅ MA200 上方
  5 日涨跌：+0.6%

🎯 参考出场:
  止盈：$157.64 (+13%)
  止损：$128.34 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

BUY_SIGNAL:CCL:95
🚀 **CCL** — 🔥 强烈信号
━━━━━━━━━━━━━━━━━━
📊 评分：95/100
💰 当前价：$31.55
⏰ 时间：2026-02-23 23:05 (北京)

📈 技术指标:
  RSI14: 24.3  |  BB%: 0.06
  MACD 柱：-0.1294  |  量比：1.38
  趋势：✅ MA200 上方
  5 日涨跌：-2.1%

🎯 参考出场:
  止盈：$35.83 (+13%)
  止损：$29.17 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

BUY_SIGNAL:ZBRA:78
🎯 **ZBRA** — ✅ 买入信号
━━━━━━━━━━━━━━━━━━
📊 评分：78/100
💰 当前价：$251.66
⏰ 时间：2026-02-23 23:05 (北京)

📈 技术指标:
  RSI14: 30.9  |  BB%: 0.329
  MACD 柱：-0.2685  |  量比：1.43
  趋势：✅ MA200 上方
  5 日涨跌：+0.9%

🎯 参考出场:
  止盈：$293.69 (+13%)
  止损：$239.11 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

BUY_SIGNAL:ETN:78
🎯 **ETN** — ✅ 买入信号
━━━━━━━━━━━━━━━━━━
📊 评分：78/100
💰 当前价：$377.31
⏰ 时间：2026-02-23 23:06 (北京)

📈 技术指标:
  RSI14: 18.6  |  BB%: 0.203
  MACD 柱：-0.9548  |  量比：1.54
  趋势：✅ MA200 上方
  5 日涨跌：-0.8%

🎯 参考出场:
  止盈：$428.5 (+13%)
  止损：$348.86 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

BUY_SIGNAL:WMT:80
🎯 **WMT** — ✅ 买入信号
━━━━━━━━━━━━━━━━━━
📊 评分：80/100
💰 当前价：$124.83
⏰ 时间：2026-02-23 23:06 (北京)

📈 技术指标:
  RSI14: 35.5  |  BB%: 0.077
  MACD 柱：-0.2115  |  量比：1.14
  趋势：✅ MA200 上方
  5 日涨跌：-0.9%

🎯 参考出场:
  止盈：$145.49 (+13%)
  止损：$118.45 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

BUY_SIGNAL:MHK:80
🎯 **MHK** — ✅ 买入信号
━━━━━━━━━━━━━━━━━━
📊 评分：80/100
💰 当前价：$128.2
⏰ 时间：2026-02-23 23:06 (北京)

📈 技术指标:
  RSI14: 31.4  |  BB%: 0.146
  MACD 柱：-0.3428  |  量比：1.57
  趋势：✅ MA200 上方
  5 日涨跌：-0.8%

🎯 参考出场:
  止盈：$144.14 (+13%)
  止损：$117.36 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

BUY_SIGNAL:CI:83
🎯 **CI** — ✅ 买入信号
━━━━━━━━━━━━━━━━━━
📊 评分：83/100
💰 当前价：$285.98
⏰ 时间：2026-02-23 23:06 (北京)

📈 技术指标:
  RSI14: 31.2  |  BB%: 0.13
  MACD 柱：-0.4403  |  量比：2.09
  趋势：✅ MA200 上方
  5 日涨跌：+0.2%

🎯 参考出场:
  止盈：$321.54 (+13%)
  止损：$261.79 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

BUY_SIGNAL:TXN:85
🚀 **TXN** — 🔥 强烈信号
━━━━━━━━━━━━━━━━━━
📊 评分：85/100
💰 当前价：$218.06
⏰ 时间：2026-02-23 23:06 (北京)

📈 技术指标:
  RSI14: 24.1  |  BB%: 0.189
  MACD 柱：-0.5979  |  量比：1.68
  趋势：✅ MA200 上方
  5 日涨跌：-0.6%

🎯 参考出场:
  止盈：$247.64 (+13%)
  止损：$201.62 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

BUY_SIGNAL:COST:90
🚀 **COST** — 🔥 强烈信号
━━━━━━━━━━━━━━━━━━
📊 评分：90/100
💰 当前价：$987.67
⏰ 时间：2026-02-23 23:07 (北京)

📈 技术指标:
  RSI14: 22.2  |  BB%: 0.177
  MACD 柱：-2.4896  |  量比：1.36
  趋势：✅ MA200 上方
  5 日涨跌：-0.3%

🎯 参考出场:
  止盈：$1121.65 (+13%)
  止损：$913.2 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

BUY_SIGNAL:PFE:73
🎯 **PFE** — ✅ 买入信号
━━━━━━━━━━━━━━━━━━
📊 评分：73/100
💰 当前价：$26.86
⏰ 时间：2026-02-23 23:07 (北京)

📈 技术指标:
  RSI14: 29.0  |  BB%: 0.274
  MACD 柱：-0.0507  |  量比：1.56
  趋势：✅ MA200 上方
  5 日涨跌：+0.7%

🎯 参考出场:
  止盈：$30.86 (+13%)
  止损：$25.13 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

BUY_SIGNAL:IP:85
🚀 **IP** — 🔥 强烈信号
━━━━━━━━━━━━━━━━━━
📊 评分：85/100
💰 当前价：$46.87
⏰ 时间：2026-02-23 23:07 (北京)

📈 技术指标:
  RSI14: 16.8  |  BB%: 0.101
  MACD 柱：-0.2589  |  量比：1.65
  趋势：✅ MA200 上方
  5 日涨跌：-1.6%

🎯 参考出场:
  止盈：$53.22 (+13%)
  止损：$43.33 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

BUY_SIGNAL:LUV:90
🚀 **LUV** — 🔥 强烈信号
━━━━━━━━━━━━━━━━━━
📊 评分：90/100
💰 当前价：$52.08
⏰ 时间：2026-02-23 23:07 (北京)

📈 技术指标:
  RSI14: 25.0  |  BB%: 0.072
  MACD 柱：-0.3015  |  量比：1.19
  趋势：✅ MA200 上方
  5 日涨跌：-1.3%

🎯 参考出场:
  止盈：$58.55 (+13%)
  止损：$47.67 (-8%)
  盈亏比：1.62:1

_仅供参考，请结合基本面和市场环境判断_
---END---

（信号已执行导出保存）
"""
# ────────────────────────────────────────────────────────────────────────


def parse_signals(raw: str):
    """从 Telegram 推送原文解析每个信号块"""
    blocks = re.split(r'(?=BUY_SIGNAL:[A-Z]+:\d+)', raw.strip())
    signals = []
    for b in blocks:
        if not b.strip():
            continue
        m = re.match(r'BUY_SIGNAL:([A-Z]+):(\d+)', b)
        if not m:
            continue
        ticker, score = m.groups()
        # 提取该信号的完整原文（到 ---END--- 为止）
        end_marker = '---END---'
        end_idx = b.find(end_marker)
        if end_idx == -1:
            end_idx = len(b)
        else:
            end_idx += len(end_marker)
        raw_text = b[:end_idx].strip()

        # 提取摘要信息
        price_m = re.search(r'💰 当前价：\$([0-9.]+)', b)
        rsi_m = re.search(r'RSI14: ([0-9.]+)', b)
        bb_m = re.search(r'BB%: ([0-9.-]+)', b)
        tp_m = re.search(r'止盈：\$([0-9.]+)', b)
        sl_m = re.search(r'止损：\$([0-9.]+)', b)
        time_m = re.search(r'⏰ 时间：([0-9-]+ [0-9:]+)', b)

        summary = f"📊 {ticker} 评分{score}｜现价${price_m.group(1) if price_m else '--'}｜"
        summary += f"RSI{rsi_m.group(1) if rsi_m else '--'}｜BB% {bb_m.group(1) if bb_m else '--'}｜"
        summary += f"TP ${tp_m.group(1) if tp_m else '--'}｜SL ${sl_m.group(1) if sl_m else '--'}"

        signals.append({
            'ticker': ticker,
            'score': int(score),
            'raw': raw_text,
            'summary': summary,
            'time': time_m.group(1) if time_m else datetime.now().strftime('%Y-%m-%d %H:%M'),
        })
    return signals


def run():
    signals = parse_signals(RAW_MSG)
    print(f"解析到 {len(signals)} 个信号")

    hist = []
    for i, s in enumerate(signals):
        hist.append({
            'id': f"hist_{s['ticker']}_{s['time'].replace(' ','_').replace(':','')}",
            'type': 'buy_signal',
            'title': f"买入信号 {s['ticker']} ({s['score']})",
            'summary': s['summary'],
            'content': s['summary'],
            'raw': s['raw'],
            'time': s['time'],
        })

    # 最新在前
    hist = list(reversed(hist))

    base = os.path.dirname(__file__)
    for path in [os.path.join(base, 'push_history.json'), os.path.join(base, '..', 'push_history.json')]:
        with open(path, 'w') as f:
            json.dump(hist, f, ensure_ascii=False, indent=2)
    print(f"✅ push_history.json 已重建：{len(hist)} 条")


if __name__ == '__main__':
    run()
