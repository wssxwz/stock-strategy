"""ç”¨ç”¨æˆ·æä¾›çš„ Telegram æ¨é€åŸæ–‡é‡å»º push_history.json

ç”¨æ³•ï¼šæŠŠ Telegram æ¨é€åŸæ–‡ç²˜è´´åˆ° RAW_MSG å˜é‡é‡Œè¿è¡Œ
"""

import json, os, re
from datetime import datetime

# â”€â”€ ç²˜è´´ä½ çš„ Telegram æ¨é€åŸæ–‡åˆ°è¿™é‡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RAW_MSG = r"""
ğŸ“£ å…¨å¸‚åœºæ‰«æä¿¡å·ï¼ˆ2026-02-23 23:07 åŒ—äº¬ï¼‰

âœ… æœ¬æ¬¡è§¦å‘ï¼šä¹°å…¥ 12 / å–å‡º 0

BUY_SIGNAL:ANET:78
ğŸ¯ **ANET** â€” âœ… ä¹°å…¥ä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š78/100
ğŸ’° å½“å‰ä»·ï¼š$137.2
â° æ—¶é—´ï¼š2026-02-23 23:05 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 29.1  |  BB%: 0.248
  MACD æŸ±ï¼š-0.4079  |  é‡æ¯”ï¼š0.79
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š+0.6%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$157.64 (+13%)
  æ­¢æŸï¼š$128.34 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

BUY_SIGNAL:CCL:95
ğŸš€ **CCL** â€” ğŸ”¥ å¼ºçƒˆä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š95/100
ğŸ’° å½“å‰ä»·ï¼š$31.55
â° æ—¶é—´ï¼š2026-02-23 23:05 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 24.3  |  BB%: 0.06
  MACD æŸ±ï¼š-0.1294  |  é‡æ¯”ï¼š1.38
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š-2.1%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$35.83 (+13%)
  æ­¢æŸï¼š$29.17 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

BUY_SIGNAL:ZBRA:78
ğŸ¯ **ZBRA** â€” âœ… ä¹°å…¥ä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š78/100
ğŸ’° å½“å‰ä»·ï¼š$251.66
â° æ—¶é—´ï¼š2026-02-23 23:05 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 30.9  |  BB%: 0.329
  MACD æŸ±ï¼š-0.2685  |  é‡æ¯”ï¼š1.43
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š+0.9%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$293.69 (+13%)
  æ­¢æŸï¼š$239.11 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

BUY_SIGNAL:ETN:78
ğŸ¯ **ETN** â€” âœ… ä¹°å…¥ä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š78/100
ğŸ’° å½“å‰ä»·ï¼š$377.31
â° æ—¶é—´ï¼š2026-02-23 23:06 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 18.6  |  BB%: 0.203
  MACD æŸ±ï¼š-0.9548  |  é‡æ¯”ï¼š1.54
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š-0.8%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$428.5 (+13%)
  æ­¢æŸï¼š$348.86 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

BUY_SIGNAL:WMT:80
ğŸ¯ **WMT** â€” âœ… ä¹°å…¥ä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š80/100
ğŸ’° å½“å‰ä»·ï¼š$124.83
â° æ—¶é—´ï¼š2026-02-23 23:06 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 35.5  |  BB%: 0.077
  MACD æŸ±ï¼š-0.2115  |  é‡æ¯”ï¼š1.14
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š-0.9%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$145.49 (+13%)
  æ­¢æŸï¼š$118.45 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

BUY_SIGNAL:MHK:80
ğŸ¯ **MHK** â€” âœ… ä¹°å…¥ä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š80/100
ğŸ’° å½“å‰ä»·ï¼š$128.2
â° æ—¶é—´ï¼š2026-02-23 23:06 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 31.4  |  BB%: 0.146
  MACD æŸ±ï¼š-0.3428  |  é‡æ¯”ï¼š1.57
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š-0.8%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$144.14 (+13%)
  æ­¢æŸï¼š$117.36 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

BUY_SIGNAL:CI:83
ğŸ¯ **CI** â€” âœ… ä¹°å…¥ä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š83/100
ğŸ’° å½“å‰ä»·ï¼š$285.98
â° æ—¶é—´ï¼š2026-02-23 23:06 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 31.2  |  BB%: 0.13
  MACD æŸ±ï¼š-0.4403  |  é‡æ¯”ï¼š2.09
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š+0.2%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$321.54 (+13%)
  æ­¢æŸï¼š$261.79 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

BUY_SIGNAL:TXN:85
ğŸš€ **TXN** â€” ğŸ”¥ å¼ºçƒˆä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š85/100
ğŸ’° å½“å‰ä»·ï¼š$218.06
â° æ—¶é—´ï¼š2026-02-23 23:06 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 24.1  |  BB%: 0.189
  MACD æŸ±ï¼š-0.5979  |  é‡æ¯”ï¼š1.68
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š-0.6%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$247.64 (+13%)
  æ­¢æŸï¼š$201.62 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

BUY_SIGNAL:COST:90
ğŸš€ **COST** â€” ğŸ”¥ å¼ºçƒˆä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š90/100
ğŸ’° å½“å‰ä»·ï¼š$987.67
â° æ—¶é—´ï¼š2026-02-23 23:07 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 22.2  |  BB%: 0.177
  MACD æŸ±ï¼š-2.4896  |  é‡æ¯”ï¼š1.36
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š-0.3%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$1121.65 (+13%)
  æ­¢æŸï¼š$913.2 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

BUY_SIGNAL:PFE:73
ğŸ¯ **PFE** â€” âœ… ä¹°å…¥ä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š73/100
ğŸ’° å½“å‰ä»·ï¼š$26.86
â° æ—¶é—´ï¼š2026-02-23 23:07 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 29.0  |  BB%: 0.274
  MACD æŸ±ï¼š-0.0507  |  é‡æ¯”ï¼š1.56
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š+0.7%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$30.86 (+13%)
  æ­¢æŸï¼š$25.13 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

BUY_SIGNAL:IP:85
ğŸš€ **IP** â€” ğŸ”¥ å¼ºçƒˆä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š85/100
ğŸ’° å½“å‰ä»·ï¼š$46.87
â° æ—¶é—´ï¼š2026-02-23 23:07 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 16.8  |  BB%: 0.101
  MACD æŸ±ï¼š-0.2589  |  é‡æ¯”ï¼š1.65
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š-1.6%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$53.22 (+13%)
  æ­¢æŸï¼š$43.33 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

BUY_SIGNAL:LUV:90
ğŸš€ **LUV** â€” ğŸ”¥ å¼ºçƒˆä¿¡å·
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯„åˆ†ï¼š90/100
ğŸ’° å½“å‰ä»·ï¼š$52.08
â° æ—¶é—´ï¼š2026-02-23 23:07 (åŒ—äº¬)

ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡:
  RSI14: 25.0  |  BB%: 0.072
  MACD æŸ±ï¼š-0.3015  |  é‡æ¯”ï¼š1.19
  è¶‹åŠ¿ï¼šâœ… MA200 ä¸Šæ–¹
  5 æ—¥æ¶¨è·Œï¼š-1.3%

ğŸ¯ å‚è€ƒå‡ºåœº:
  æ­¢ç›ˆï¼š$58.55 (+13%)
  æ­¢æŸï¼š$47.67 (-8%)
  ç›ˆäºæ¯”ï¼š1.62:1

_ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆåŸºæœ¬é¢å’Œå¸‚åœºç¯å¢ƒåˆ¤æ–­_
---END---

ï¼ˆä¿¡å·å·²æ‰§è¡Œå¯¼å‡ºä¿å­˜ï¼‰
"""
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


def parse_signals(raw: str):
    """ä» Telegram æ¨é€åŸæ–‡è§£ææ¯ä¸ªä¿¡å·å—"""
    blocks = re.split(r'(?=BUY_SIGNAL:[A-Z]+:\d+)', raw.strip())
    signals = []
    for b in blocks:
        if not b.strip():
            continue
        m = re.match(r'BUY_SIGNAL:([A-Z]+):(\d+)', b)
        if not m:
            continue
        ticker, score = m.groups()
        # æå–è¯¥ä¿¡å·çš„å®Œæ•´åŸæ–‡ï¼ˆåˆ° ---END--- ä¸ºæ­¢ï¼‰
        end_marker = '---END---'
        end_idx = b.find(end_marker)
        if end_idx == -1:
            end_idx = len(b)
        else:
            end_idx += len(end_marker)
        raw_text = b[:end_idx].strip()

        # æå–æ‘˜è¦ä¿¡æ¯
        price_m = re.search(r'ğŸ’° å½“å‰ä»·ï¼š\$([0-9.]+)', b)
        rsi_m = re.search(r'RSI14: ([0-9.]+)', b)
        bb_m = re.search(r'BB%: ([0-9.-]+)', b)
        tp_m = re.search(r'æ­¢ç›ˆï¼š\$([0-9.]+)', b)
        sl_m = re.search(r'æ­¢æŸï¼š\$([0-9.]+)', b)
        time_m = re.search(r'â° æ—¶é—´ï¼š([0-9-]+ [0-9:]+)', b)

        summary = f"ğŸ“Š {ticker} è¯„åˆ†{score}ï½œç°ä»·${price_m.group(1) if price_m else '--'}ï½œ"
        summary += f"RSI{rsi_m.group(1) if rsi_m else '--'}ï½œBB% {bb_m.group(1) if bb_m else '--'}ï½œ"
        summary += f"TP ${tp_m.group(1) if tp_m else '--'}ï½œSL ${sl_m.group(1) if sl_m else '--'}"

        signals.append({
            'ticker': ticker,
            'score': int(score),
            'raw': raw_text,
            'summary': summary,
            'time': time_m.group(1) if time_m else datetime.now().strftime('%Y-%m-%d %H:%M'),
        })
    return signals


def run():
    signals = parse_signals(RAW_MSG)
    print(f"è§£æåˆ° {len(signals)} ä¸ªä¿¡å·")

    # æå–æ‰¹æ¬¡æ ‡é¢˜ï¼ˆä»åŸæ–‡ç¬¬ä¸€è¡Œï¼‰
    first_line = RAW_MSG.strip().split('\n')[0]
    batch_title = first_line  # ğŸ“£ å…¨å¸‚åœºæ‰«æä¿¡å·ï¼ˆ2026-02-23 23:07 åŒ—äº¬ï¼‰

    # ç»Ÿè®¡
    buy_count = len(signals)
    strong_count = sum(1 for s in signals if s['score'] >= 85)

    # æ‘˜è¦ï¼šä¸€è¡Œæ˜¾ç¤ºæ‰¹æ¬¡ä¿¡æ¯
    batch_summary = f"âœ… ä¹°å…¥ {buy_count} / å–å‡º 0ï½œå¼ºè¶‹åŠ¿ {strong_count} åªï½œ{signals[0]['time'] if signals else ''}"

    # åˆå¹¶æˆ 1 æ¡è®°å½•
    hist = [{
        'id': f"batch_{signals[0]['time'].replace(' ','_').replace(':','')}" if signals else f"batch_{datetime.now().strftime('%Y%m%d_%H%M')}",
        'type': 'buy_signal_batch',
        'title': batch_title,
        'summary': batch_summary,
        'content': batch_summary,
        'raw': RAW_MSG.strip(),
        'time': signals[0]['time'] if signals else datetime.now().strftime('%Y-%m-%d %H:%M'),
        'signal_count': buy_count,
        'strong_count': strong_count,
        'signals': [{'ticker': s['ticker'], 'score': s['score'], 'summary': s['summary']} for s in signals],
    }]

    base = os.path.dirname(__file__)
    for path in [os.path.join(base, 'push_history.json'), os.path.join(base, '..', 'push_history.json')]:
        with open(path, 'w') as f:
            json.dump(hist, f, ensure_ascii=False, indent=2)
    print(f"âœ… push_history.json å·²é‡å»ºï¼š1 æ¡æ‰¹æ¬¡è®°å½•ï¼ˆå« {buy_count} ä¸ªä¿¡å·ï¼‰")


if __name__ == '__main__':
    run()
